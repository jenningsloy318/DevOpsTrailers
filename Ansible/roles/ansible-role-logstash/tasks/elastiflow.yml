
- name: download  and extract elastiflow
  unarchive:
      src: https://github.com/robcowart/elastiflow/archive/master.zip
      dest: /tmp  
      remote_src: yes 

- name: configure JVM heap (1)
  lineinfile:
      path: /etc/logstash/jvm.options  
      regexp: '^-Xms\\d+g$' 
      backup: yes
      line: '-Xms4g'

- name: configure JVM heap (2)
  lineinfile:
      path: /etc/logstash/jvm.options  
      regexp: '^-Xmx\\d+g$' 
      backup: yes
      line: '-Xmx4g'      

- name: install  logstash-codec-sflow plugins
  shell: /usr/share/logstash/bin/logstash-plugin install logstash-codec-sflow
  args:
    warn: no
    executable: /bin/bash
  
- name: update logstash plugins
  shell: /usr/share/logstash/bin/logstash-plugin update "{{item}}"
  with_items:
  - logstash-codec-netflow
  - logstash-input-udp
  - logstash-filter-dns
  args:
    warn: no
    executable: /bin/bash

- name: copy elastiflow to /etc/logstash
  shell: cp -a /tmp/elastiflow-master/logstash/elastiflow /etc/logstash/
  args:
    warn: no
    executable: /bin/bash

- name: copy elastiflow systemd conf 
  shell: sudo cp -a /tmp/elastiflow-master/logstash.service.d /etc/systemd/system/
  args:
    warn: no
    executable: /bin/bash

- name:  add elastiflow to logstash pipeline
  copy:
      src: /etc/logstash/pipelines.yml  
      dest: /etc/logstash/pipelines.yml  

- name: enable ES cluster output
  shell: mv 30_output_10_single.logstash.conf 30_output_10_single.logstash.conf.disabled && mv 30_output_20_multi.logstash.conf.disabled 30_output_20_multi.logstash.conf
  args:
    chdir: /etc/logstash/elastiflow/conf.d/
    warn: no
    executable: /bin/bash

- name: configure ES cluster nodes (1)
  lineinfile:
    path:  /etc/systemd/system/logstash.service.d/elastiflow.conf
    regexp: '^Environment="ELASTIFLOW_ES_HOST=.*$'
    state: absent

- name: configure ES cluster nodes (2)
  lineinfile:
    path:  /etc/systemd/system/logstash.service.d/elastiflow.conf
    regexp: '^(Environment="ELASTIFLOW_ES_HOST_1)=.*$'
    line:  '\1={{ES_HOST_1}}:9200"'
    backrefs: yes

- name: configure ES cluster nodes (3)
  lineinfile:
    path:  /etc/systemd/system/logstash.service.d/elastiflow.conf
    regexp: '^(Environment="ELASTIFLOW_ES_HOST_2)=.*$'
    line:  '\1={{ES_HOST_2}}:9200"'
    backrefs: yes

- name: configure ES cluster nodes (4)
  lineinfile:
    path:  /etc/systemd/system/logstash.service.d/elastiflow.conf
    regexp: '^(Environment="ELASTIFLOW_ES_HOST_3)=.*$'
    line:  '\1={{ES_HOST_3}}:9200"'
    backrefs: yes

- name: restart logstash 
  systemd:
    name: logstash
    state: restarted
    daemon_reload: yes
- name: set up index for elastiflow on kibana
  uri:
    url: "http://{{KIBABA_HOST}}:5601/api/saved_objects/index-pattern/elastiflow-*"
    method: POST
    body: /tmp/elastiflow-master/kibana/elastiflow.index_pattern.json
    body_format: json
    headers:
        Content-Type: "application/json"
        kbn-xsrf: true

- name: set up index for elastiflow on kibana
  uri:
    url:  "http://{{KIBABA_HOST}}:5601//api/kibana/dashboards/import" 
    method: POST
    body: /tmp/elastiflow-master/kibana/elastiflow.dashboards.6.4.x.json
    body_format: json
    headers:
        Content-Type: "application/json"
        kbn-xsrf: true