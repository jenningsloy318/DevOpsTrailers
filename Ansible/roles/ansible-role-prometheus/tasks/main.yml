
- name: add prometheus repo
  yum_repository:
    name: prometheus
    description: prometheus repo
    baseurl: https://packagecloud.io/prometheus-rpm/release/el/7/$basearch
    repo_gpgcheck: 1
    enabled: 1
    gpgkey: https://packagecloud.io/prometheus-rpm/release/gpgkey
            https://raw.githubusercontent.com/lest/prometheus-rpm/master/RPM-GPG-KEY-prometheus-rpm
    gpgcheck: 1
    sslverify: 1
    sslcacert: /etc/pki/tls/certs/ca-bundle.crt
    metadata_expire: 300
- name: install prometheus package
  package:
    name: "{{item}}"
    state: latest
  with_items:
  - prometheus2

- name: create prometheus service file
  template:
    src: prometheus.service.j2
    dest: /lib/systemd/system/prometheus.service


- name: create prometheus file sd dir
  file:
    path: /etc/prometheus/tgroups/
    state: directory
    mode: 0755
    owner: prometheus
    group: prometheus


- name: create prometheus conf file
  template:
    src: "{{item.src}}"
    dest: "{{item.target}}"
    mode: 0755
    owner: prometheus
    group: prometheus
  notify:
    reload_prometheus_conf
  with_items:
  - {src: "alertmanagers.yml.j2",target: "/etc/prometheus/alertmanagers.yml"}
  - {src: "prometheus.yml.j2",target: "/etc/prometheus/prometheus.yml"}



- name: create alert.rules.yml conf file
  copy:
    src: alert.rules.yml
    dest: /etc/prometheus/alert.rules.yml

- name: start prometheus service if not running
  systemd: 
    name: prometheus
    state: started
    enabled: yes
    daemon_reload: yes

- name: change file owner
  file:
    path: "{{item}}"
    owner: prometheus
    group: prometheus
    recurse: yes
  with_items:
  - "{{ prometheus_storage_tsdb_path}}"
  - /etc/prometheus
  notify:
    reload_prometheus_conf  

- name: and more targets
  copy:
    src: "{{item.job_name}}-targets.yml"
    dest: /etc/prometheus/tgroups/
    mode: 0755
  with_items:
  - "{{prometheus_job_list}}"




