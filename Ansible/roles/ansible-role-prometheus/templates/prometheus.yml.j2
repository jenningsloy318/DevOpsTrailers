global:
  scrape_interval: 15s
rule_files:
- '/etc/prometheus/alert.rules.yml'

scrape_configs:
{% for job in prometheus_job_list %}

{% if job.job_name == 'prometheus' %}
- job_name: 'prometheus services'
  metrics_path: {{ job.metrics_path }}
  file_sd_configs:
    - files: ['tgroups/prometheus-targets.yml']  
{%endif%}

{% if job.job_name == 'alertmanager' %}
- job_name: 'alertmanager services'
  metrics_path: {{ job.metrics_path }}
  file_sd_configs:
    - files: ['tgroups/alertmanager-targets.yml']  
{%endif%}

{% if job.job_name == 'grafana' %}
- job_name: 'grafana services'
  metrics_path: {{ job.metrics_path }}
  file_sd_configs:
    - files: ['tgroups/grafana-targets.yml']  
{%endif%}

{% if job.job_name == 'telegraf' %}
- job_name: 'tegraf'
  metrics_path: {{ job.metrics_path }}
  file_sd_configs:
    - files: ['tgroups/telegraf-targets.yml']
  relabel_configs:
    - source_labels: [__address__]
      regex: '(.*):.*'
      target_label: instance
      replacement: ${1}
{%endif%}

{% if job.job_name == 'mysql' %}
- job_name: 'mysql exporter'
  metrics_path: {{ job.metrics_path }}
  file_sd_configs:
  - files: ['tgroups/mysql-targets.yml']
{%endif%}


{% if job.job_name == 'hana' %}

- job_name: 'hana exporter'
  metrics_path: {{ job.metrics_path }}
  scrape_timeout: 30s
  scrape_interval: 30s
  file_sd_configs:
    - files: ['tgroups/hana-targets.yml']  
  relabel_configs:
     - source_labels: [__address__]
       target_label: __param_target
     - source_labels: [__param_target]
       target_label: instance
     - target_label: __address__
       replacement: {{job.hana_exporter_host}}:9460  ### the address of the hana-exporter address
{%endif%}

{% if job.job_name == 'blackbox' %}
- job_name: blackbox exporter
  metrics_path: '{{ job.metrics_path }}'
  params:
    module: [http_2xx]
  file_sd_configs:
    - files: ['tgroups/blackbox-targets.yml']  
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: {{job.blackbox_exporter_host}}:9115  # The blackbox exporter's real hostname:port.

{%endif%}

{% if job.job_name == 'nginx' %}
- job_name: 'nginx exporter'
  metrics_path: {{ job.metrics_path }}
  file_sd_configs:
  - files: ['tgroups/nginx-targets.yml']
{%endif%}

{% if job.job_name == 'netapp-harvest' %}
- job_name: 'netapp-harvest'
  metrics_path: {{ job.metrics_path }}
  file_sd_configs:
  - files: ['tgroups/netapp.yml']
{%endif%}

{%endfor%}

alerting:
  alertmanagers:
  - file_sd_configs:
    - files: ['/etc/prometheus/alertmanagers.yml']
